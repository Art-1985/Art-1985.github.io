<!DOCTYPE html>
<!-- 這是註解 -->
<html>
  <head>
    <meta charset="utf-8">
    <title>計算機架構</title>
  </head>

  <body>
    <p>
        ARM有七種模式，我們這裡只討論SVC、IRQ和FIQ模式。<br>
        我們可以假設ARM核心有兩根中斷引腳（實際上是看不見的），一根叫 irq pin， 一根叫fiq pin。在ARM的cpsr中，有一個I位和一個F位，分別用來禁止IRQ和FIQ。<br>
        先不說中斷控制器，只說ARM核心。正常情況下，ARM核都只是機械地隨著pc的指示去做事情，當CPSR中的I和F位為1時，IRQ和FIQ全部處於禁止狀態。<br>
        無論你在irq pin和fiq pin上面發什麼樣的中斷訊號，ARM不會理你，你根本不能打斷它，因為它“耳聾”，“眼瞎”了。<br>
        當I位和F位為0時，irq pin上有中斷訊號過來時，就會打斷arm的當前工作，並且切換到IRQ模式下，跳到相應的異常向量表（vector）位置去執行程式碼。這個過程是自動的，但是返回到被中斷打斷的地方就得您親自動手。<br>
        當你跳到異常向量表，處於IRQ的模式的時候，此時如果irq pin上面又來中斷訊號，此時ARM是不會理你的，irq pin就像祕書，ARM核心就像老闆，老闆本來在做事，然後來了一個客戶，祕書打斷它，讓客戶進去。而此時再來一個客戶，要麼祕書不斷去敲門問，要麼客戶走人。老闆第一個客戶沒有會見完，不會理你。<br>
        但是有一種情況例外，當ARM處在IRQ模式，這個時候fiq pin來了一箇中斷訊號，fiq pin是什麼？快速中斷，好比公安局的來查刑事案件，才不管老闆是不是在會見客戶，直接打斷，進入到fiq模式，跳到相應的fiq的異常向量表處去執行程式碼。<br>
        那如果當ARM處理FIQ模式，fiq pin又來中斷訊號，也就是又一批公安來了，那沒戲，都是執法人員，你打不斷我。如果此時irq pin來了呢？來了也不理，正在辦案，還敢來妨礙公務。<br>
        所以得出一個結論： IRQ模式只能被FIQ模式打斷，FIQ模式下誰也打不斷。<br>
        在打不斷的情況下，irq pin 或fiq pin隨便你怎麼發中斷訊號，都是白髮。<br>
        所以除了fiq能打斷irq以外，根本沒有所謂中斷巢狀的情況。<br>
        但是再怎麼說irq pin 和fiq pin加起來也就2根引腳，這麼多中斷源，怎麼辦呢？不可能誰來了都直接敲門吧。<br>
        接下來該說誰來給irq pin或者 fiq pin發訊號。從上文可以看到，可能是老闆客戶，也可能是公安。在ARM中，這個事情由中斷控制器管理。<br>
        拿最簡單的2410/2440的中斷控制器舉例，中斷控制器加一個子中斷控制器，還有一個外部中斷控制器管理了50多箇中斷資源，說穿了有50多個腳。<br>
        這些腳除了外部中斷都是規定了功能的，比如WDT、LCD、DMA等，這個功能不能改，因為2410/2440內部硬體連線已經決定了。<br>
        當WDT和DMA中斷都到來時，會被送到SRCPND暫存器中，兩個中斷都在裡面，到底把哪一個送給ARM呢？這個時候先看INTMOD，也就是中斷模式暫存器：哪個中斷被設定成快速中斷，哪個就被送上去；如果兩個都被設定為快速中斷呢？<br>
        這不可能，因為同一時間只能有一箇中斷可以被設成快速中斷。所以，如果有快速中斷，這個時候直接給fiq pin發中斷訊號，打斷ARM。<br>
        要是沒有快速中斷呢，這個時候就看INTMSK，看WDT和DMA有沒有被遮蔽，如果DMA在INTMSK被遮蔽，只有WDT繼續向上送，如果都沒有遮蔽，那麼他們兩個同時進入優先順序暫存器PRIORITY，在這裡根據優先順序設定，一定會分出一個高一個低的優先順序出來，優先順序高的那個被送到INTPND暫存器，所以INTPND隨時隨地有且只有一箇中斷在裡面。<br>
        只要INTPND裡面有中斷，irq pin就不會一直不斷給ARM發中斷訊號，當第一次發的時候，中斷了ARM，這個時候ARM進入相應的異常向量並處於IRQ模式。<br>
        此時，INTPND仍然不斷的通過irq pin向ARM發中斷訊號，但是此時ARM已經處於IRQ模式，不會理睬你。當你中斷處理完，要退出IRQ模式，這個時候要小心，如果退出IRQ模式之前不清除INTPND裡面的中斷位，剛退出IRQ模式，又會被中斷，因為INTPND一直在發中斷訊號。所以在退出IRQ模式前一定要清除INTPND裡面的中斷位。<br>
        光清除INTPND裡面的位還不行，因為SRCPND裡面WDT和DMA的中斷在，當你剛清除完INTPND，結果SRCPND裡面又選了一箇中斷出來送到INTPND裡面。所以正確的處理方法是退出IRQ模式之前，先清除SRCPND裡相應的中斷位，再清除INTPND裡相應的位。請注意，SRCPND裡面可能有多個位，所以清除你已處理過的中斷就行，而INTPND裡面只可能有一位，直接清掉即可。<br>
        再說說Linux的情況。Linux不用FIQ，只用到了IRQ。但是我們有時候一箇中斷需要處理很長時間，我們需要佔用IRQ模式那麼長的時間嗎？不需要，linux在IRQ模式下只是簡單的記錄是什麼中斷，馬上切換回SVC模式，換句話說，linux的中斷處理都是在SVC模式下處理的。<br>
        那麼中斷號是怎麼來的呢？它在ARM上固定死了，相應的中斷號只有一個辦法得到：查詢irqs.h 。先用一箇中斷號註冊一箇中斷處理程式，當中斷髮生的時候，Linux怎麼知道是我這個中斷號發生的中斷呢？在處理中斷的時候，先讀取INTPND，根據需要再讀取EINTPEND或SUBSRCPND計算出一箇中斷號，相應的處理演算法在get_irq_nr_base這個巨集中。irqs.h中的中斷號就是根據這個演算法把每個中斷號算出來的。<br>
    </p>
  </body>
</html>

